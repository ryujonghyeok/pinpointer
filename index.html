<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Precision Finding</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel for in-browser JSX compilation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Prevent pull-to-refresh and bounce scrolling on mobile for a native app feel */
    body {
      overscroll-behavior-y: none;
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // --- Inline Icons (Replacing lucide-react to avoid import errors) ---
    const Icon = ({ children, className = "", size = 24 }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {children}
      </svg>
    );
    const SearchIcon = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
    const CrosshairIcon = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="22" x2="18" y1="12" y2="12"/><line x1="6" x2="2" y1="12" y2="12"/><line x1="12" x2="12" y1="6" y2="2"/><line x1="12" x2="12" y1="22" y2="18"/></Icon>;
    const MapPinIcon = (props) => <Icon {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></Icon>;
    const CompassIcon = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></Icon>;
    const XIcon = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
    const Volume2Icon = (props) => <Icon {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></Icon>;

    // --- Math & Geo Utilities ---
    const toRad = (value) => (value * Math.PI) / 180;
    const toDeg = (value) => (value * 180) / Math.PI;

    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371e3;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    };

    const calculateBearing = (lat1, lon1, lat2, lon2) => {
      const dLon = toRad(lon2 - lon1);
      const y = Math.sin(dLon) * Math.cos(toRad(lat2));
      const x =
        Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
        Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
      const bearing = Math.atan2(y, x);
      return (toDeg(bearing) + 360) % 360;
    };

    // --- Main App Component ---
    function App() {
      const [appState, setAppState] = useState('SEARCH');
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [isSearching, setIsSearching] = useState(false);
      const [target, setTarget] = useState(null);

      const [currentLoc, setCurrentLoc] = useState(null);
      const [heading, setHeading] = useState(0);
      const [geoError, setGeoError] = useState(null);
      
      const [distance, setDistance] = useState(0);
      const [bearing, setBearing] = useState(0);

      const handleSearch = async (e) => {
        e.preventDefault();
        if (!searchQuery.trim()) return;
        
        setIsSearching(true);
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5`);
          const data = await res.json();
          setSearchResults(data);
        } catch (err) {
          console.error("Search failed:", err.message || err);
          alert("Failed to search location. Please check your connection.");
        } finally {
          setIsSearching(false);
        }
      };

      const selectTarget = (item) => {
        const newTarget = {
          lat: parseFloat(item.lat),
          lon: parseFloat(item.lon),
          name: item.display_name.split(',')[0]
        };
        setTarget(newTarget);
        setAppState('TRACKING');
        startSensors(newTarget);
      };

      const handleOrientation = useCallback((event) => {
        let compassHeading = null;
        if (event.webkitCompassHeading) {
          compassHeading = event.webkitCompassHeading;
        } else if (event.alpha !== null) {
          compassHeading = 360 - event.alpha;
        }
        
        if (compassHeading !== null) {
          setHeading(compassHeading);
        }
      }, []);

      const startSensors = async (currentTarget) => {
        setGeoError(null);

        if ('geolocation' in navigator) {
          navigator.geolocation.watchPosition(
            (position) => {
              setCurrentLoc({
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                accuracy: position.coords.accuracy
              });
            },
            (error) => {
              console.error("Geolocation error:", error.message || error);
              setGeoError("GPS blocked/unavailable. Using simulated location.");
              if (currentTarget) {
                setCurrentLoc({
                  lat: currentTarget.lat - 0.0003,
                  lon: currentTarget.lon - 0.0003,
                  accuracy: 5
                });
              }
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
          );
        } else {
          setGeoError("Geolocation is not supported by your browser.");
        }

        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === 'granted') {
              window.addEventListener('deviceorientation', handleOrientation, true);
            } else {
              setGeoError("Compass permission denied. Tap here to try again.");
            }
          } catch (err) {
            console.error("Orientation permission error:", err.message || err);
          }
        } else {
          window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        }
      };

      const stopTracking = () => {
        setAppState('SEARCH');
        setTarget(null);
        setCurrentLoc(null);
      };

      useEffect(() => {
        if (currentLoc && target) {
          const distMeters = calculateDistance(currentLoc.lat, currentLoc.lon, target.lat, target.lon);
          const bear = calculateBearing(currentLoc.lat, currentLoc.lon, target.lat, target.lon);
          setDistance(distMeters);
          setBearing(bear);
        }
      }, [currentLoc, target]);

      const formatDistance = (meters) => {
        const feet = meters * 3.28084;
        if (feet < 1000) {
          return { value: Math.round(feet), unit: 'ft' };
        } else {
          const miles = feet / 5280;
          return { value: miles.toFixed(1), unit: 'mi' };
        }
      };

      const getDirectionText = (rotation) => {
        let normalized = ((rotation % 360) + 360) % 360;
        if (normalized > 180) normalized -= 360;

        if (Math.abs(normalized) <= 45) return 'ahead';
        if (Math.abs(normalized) >= 135) return 'behind';
        if (normalized > 45 && normalized < 135) return 'to your right';
        if (normalized < -45 && normalized > -135) return 'to your left';
        return 'around';
      };

      if (appState === 'SEARCH') {
        return (
          <div className="flex flex-col h-screen max-w-md mx-auto bg-gray-50 text-gray-900 font-sans shadow-xl overflow-hidden relative">
            <div className="p-6 bg-white border-b border-gray-200 shadow-sm z-10">
              <h1 className="text-2xl font-bold mb-2">Find Location</h1>
              <p className="text-sm text-gray-500 mb-6">Search for a destination to begin precision tracking.</p>
              
              <form onSubmit={handleSearch} className="flex gap-2">
                <div className="relative flex-1">
                  <div className="absolute left-3 top-3 text-gray-400">
                    <SearchIcon size={20} />
                  </div>
                  <input 
                    type="text" 
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="Enter address..." 
                    className="w-full pl-10 pr-4 py-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-[#1cd05a] transition-all"
                  />
                </div>
                <button 
                  type="submit" 
                  disabled={isSearching || !searchQuery}
                  className="bg-[#1cd05a] text-white p-3 rounded-xl hover:bg-green-600 disabled:opacity-50 transition-all flex items-center justify-center"
                >
                  {isSearching ? <CrosshairIcon size={20} className="animate-spin" /> : <SearchIcon size={20} />}
                </button>
              </form>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {searchResults.map((item, idx) => (
                <div 
                  key={idx} 
                  onClick={() => selectTarget(item)}
                  className="flex items-start p-4 bg-white rounded-xl shadow-sm cursor-pointer hover:shadow-md transition-all active:scale-[0.98]"
                >
                  <div className="bg-green-100 p-2 rounded-full mr-4 text-[#1cd05a] flex-shrink-0">
                    <MapPinIcon size={20} />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-semibold text-gray-900 line-clamp-1">{item.display_name.split(',')[0]}</h3>
                    <p className="text-xs text-gray-500 line-clamp-2 mt-1">{item.display_name}</p>
                  </div>
                </div>
              ))}
              
              {!isSearching && searchResults.length === 0 && (
                <div className="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 mt-12">
                  <CompassIcon size={48} className="mb-4" />
                  <p>Search for a place to get started</p>
                </div>
              )}
            </div>
          </div>
        );
      }

      const { value: distValue, unit: distUnit } = formatDistance(distance);
      const arrowRotation = bearing - heading;
      const directionText = getDirectionText(arrowRotation);

      return (
        <div className="flex flex-col h-screen w-full max-w-md mx-auto bg-[#1cd05a] text-white font-sans overflow-hidden relative selection:bg-transparent touch-none">
          
          {/* Background pulsing circle effect */}
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-72 h-72 bg-white/10 rounded-full blur-2xl animate-pulse pointer-events-none"></div>
          <div className="absolute top-1/4 right-1/4 w-24 h-24 bg-white/20 rounded-full blur-xl animate-pulse pointer-events-none" style={{animationDelay: '1s'}}></div>

          {/* Top Header */}
          <div className="pt-16 px-8 relative z-10">
            <p className="text-white/80 text-xs font-bold tracking-widest uppercase mb-1">Finding</p>
            <h1 className="text-4xl font-bold tracking-tight shadow-sm line-clamp-1">{target?.name}</h1>
          </div>

          {/* Main Center Area (Arrow) */}
          <div className="flex-1 flex items-center justify-center relative z-10">
            {!currentLoc ? (
              <div className="flex flex-col items-center animate-pulse">
                <CompassIcon size={64} className="text-white/50 mb-4 animate-spin" style={{ animationDuration: '3s' }} />
                <p className="text-lg font-medium">Acquiring GPS...</p>
                {geoError && (
                  <button onClick={() => startSensors(target)} className="text-sm text-red-200 mt-4 bg-red-900/40 p-3 rounded-lg max-w-xs text-center hover:bg-red-900/60 transition">
                    {geoError}
                  </button>
                )}
              </div>
            ) : (
              <div className="relative flex items-center justify-center">
                <div 
                  className="absolute w-12 h-12 bg-white/20 rounded-full flex items-center justify-center transition-all duration-700 ease-out"
                  style={{ transform: `translate(0px, -120px)` }}
                >
                   <div className="w-4 h-4 bg-white rounded-full shadow-lg"></div>
                </div>

                <svg 
                  viewBox="0 0 24 24" 
                  fill="none" 
                  stroke="white" 
                  strokeWidth="3.5" 
                  strokeLinecap="round" 
                  strokeLinejoin="round" 
                  className="w-56 h-56 drop-shadow-2xl will-change-transform"
                  style={{ 
                    transform: `rotate(${arrowRotation}deg)`, 
                    transition: 'transform 0.15s cubic-bezier(0.2, 0.8, 0.2, 1)' 
                  }}
                >
                  <path d="M12 21V4" />
                  <path d="M5 11l7-7 7 7" />
                </svg>
              </div>
            )}
          </div>

          {/* Bottom Area (Distance & Controls) */}
          <div className="pb-12 px-8 relative z-10">
            {currentLoc && (
              <div className="mb-8">
                <div className="flex items-baseline gap-1 drop-shadow-md">
                  <span className="text-7xl font-semibold tracking-tighter">{distValue}</span>
                  <span className="text-3xl font-medium text-white/80">{distUnit}</span>
                </div>
                <p className="text-4xl font-medium tracking-tight drop-shadow-md capitalize">
                  {directionText}
                </p>
              </div>
            )}

            <div className="flex justify-between items-center mt-6">
              <button 
                onClick={stopTracking}
                className="w-14 h-14 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center hover:bg-white/30 transition-colors active:scale-90"
              >
                <XIcon size={28} />
              </button>
              
              <button 
                className="w-14 h-14 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center hover:bg-white/30 transition-colors active:scale-90"
                onClick={() => alert('Playing sound on target... (Simulated)')}
              >
                <Volume2Icon size={24} />
              </button>
            </div>
          </div>
          
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>